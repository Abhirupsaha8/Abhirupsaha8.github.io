<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video True Stereo Pan</title>
</head>
<body>

<h3>Video with True Stereo Pan</h3>

<video id="video" width="640" controls>
  <source src="./videos/mozart_VA.mp4" type="video/mp4">
</video>

<br><br>

<label for="pan">Pan:</label>
<input type="range" id="pan" min="-1" max="1" step="0.01" value="0">
<span id="panValue">0</span>

<script>
  const video = document.getElementById("video");
  const panSlider = document.getElementById("pan");
  const panValue = document.getElementById("panValue");

  // Create AudioContext
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  // Create media source
  const source = audioCtx.createMediaElementSource(video);

  // Force stereo
  source.channelCount = 2;
  source.channelCountMode = "explicit";
  source.channelInterpretation = "speakers";
  console.log("Decoded channels:", source.channelCount); // should be 2

  // Split channels
  const splitter = audioCtx.createChannelSplitter(2);
const gainL = audioCtx.createGain();
const gainR = audioCtx.createGain();
const merger = audioCtx.createChannelMerger(2);

source.connect(splitter);

// Left channel
splitter.connect(gainL, 0);
gainL.connect(merger, 0, 0); // connect left to left output

// Right channel
splitter.connect(gainR, 1);
gainR.connect(merger, 0, 1); // connect right to right output

merger.connect(audioCtx.destination);

// Pan logic: move content between left and right
panSlider.addEventListener("input", () => {
    const pan = parseFloat(panSlider.value);

    // Linear pan:
    // -1 = only left
    // 0 = both channels
    // 1 = only right
    if (pan < 0) {
        gainL.gain.value = 1;
        gainR.gain.value = 1 + pan; // pan is negative, gainR < 1
    } else {
        gainL.gain.value = 1 - pan; // gainL < 1
        gainR.gain.value = 1;
    }

    panValue.textContent = pan.toFixed(2);
});


  // Resume AudioContext on play (needed for most browsers)
  video.addEventListener("play", () => {
    if (audioCtx.state === "suspended") {
      audioCtx.resume();
    }
  });
</script>

</body>
</html>
